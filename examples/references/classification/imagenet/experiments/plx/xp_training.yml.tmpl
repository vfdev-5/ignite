---
version: 1
kind: experiment

tags: ["training", "resnet50"]

# Setup running node:
environment:
  node_selector:
    polyaxon: multigpu
  resources:
      gpu:
        requests: 2
        limits: 2

# Setup running environment:
build:
  image: pytorchignite/apex-vision:latest
  build_steps:
  # Install other useful packages
  - pip install "polyaxon-client<1.0" tqdm pynvml


declarations:
  config_file: "baseline_resnet50.py"
  script_file: "training.py"
  num_gpus: 2

run:
  cmd:
  - export LC_ALL=C.UTF-8 && export LANG=C.UTF-8
  - export PYTHONPATH=$PYTHONPATH:$PWD/code/

  # Required env variables to define dataset placement
  - export DATASET_PATH=/path/to/ImageNet-1k/

  - export config_file=$PWD/configs/train/{{config_file}}
  - export script_file=$PWD/code/scripts/{{script_file}}

  # Copy configuration file to the output
  - cp $config_file $POLYAXON_RUN_OUTPUTS_PATH
  - cp $script_file $POLYAXON_RUN_OUTPUTS_PATH

  - python -m torch.distributed.launch --nproc_per_node={{num_gpus}} -m py_config_runner $script_file $config_file